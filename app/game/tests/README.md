# Тесты игровой логики

## Структура тестов

```
app/game/tests/
├── __init__.py
├── conftest.py                    # Фикстуры для тестов
├── test_game_logic_2players.py   # Тесты для игры на 2 игроков
├── test_game_logic_3players.py   # Тесты для игры на 3 игроков
├── test_game_balances.py          # Тесты изменения балансов
└── README.md                     # Эта документация
```

## Настройка перед запуском тестов

### 1. Создание тестовых пользователей

Перед запуском тестов создайте тестовых пользователей в БД:

```bash
python scripts/create_test_users.py
```

Это создаст/обновит трёх тестовых пользователей:
- **tg_id: 111111** - баланс 10000
- **tg_id: 222222** - баланс 10000  
- **tg_id: 333333** - баланс 10000

### 2. Запуск тестов

```bash
# Запустить все тесты
pytest app/game/tests/

# Запустить конкретный тест
pytest app/game/tests/test_game_logic_2players.py

# Запустить с подробным выводом
pytest app/game/tests/ -v

# Запустить конкретный тест-кейс
pytest app/game/tests/test_game_logic_2players.py::test_2players_full_game_winner_loser_balances -v
```

## Тестовые сценарии

### Игра на 2 игроков (`test_game_logic_2players.py`)

1. **test_2players_full_game_winner_loser_balances**
   - Полная игра на 2 игроков
   - Проверка создания комнаты
   - Проверка старта игры
   - Проверка завершения через лив
   - Проверка изменения балансов (+1000 победителю, -1000 проигравшему)
   - Проверка записей GameResult (WIN и LOSS_BY_LEAVE)

2. **test_2players_insufficient_balance**
   - Игрок с недостаточным балансом не может создать комнату
   - Проверка валидации баланса

### Игра на 3 игроков (`test_game_logic_3players.py`)

1. **test_3players_leave_continues_game**
   - Игра на 3 игроков
   - Лив одного игрока во время игры
   - Игра продолжается между оставшимися 2 игроками
   - Проверка, что ливер записан как LOSS_BY_LEAVE
   - Завершение игры после второго лива
   - Проверка балансов (победитель получает ставки обоих проигравших)

### Балансы (`test_game_balances.py`)

1. **test_2players_balance_calculation**
   - Проверка правильности расчёта балансов для 2 игроков
   - Победитель: +1000
   - Проигравший: -1000

2. **test_3players_balance_calculation**
   - Проверка правильности расчёта балансов для 3 игроков
   - Победитель: +2000 (ставки 2 проигравших)
   - Проигравшие: -1000 каждый

## Что тестируется

### Логика игры
- ✅ Создание комнаты
- ✅ Присоединение игроков
- ✅ Старт игры (раздача карт)
- ✅ Завершение игры через лив
- ✅ Продолжение игры после лива (для 3 игроков)

### Финансовые операции
- ✅ Проверка баланса при создании комнаты
- ✅ Списание ставки при завершении игры
- ✅ Начисление выигрыша победителю
- ✅ Правильность расчётов для 2 и 3 игроков

### Записи в БД
- ✅ GameResult записи (WIN, LOSS, LOSS_BY_LEAVE)
- ✅ PaymentTransaction записи (через проверку балансов)

## Планируемые тесты (TODO)

- [ ] Тесты режима redeal (пересдача при особых комбинациях)
- [ ] Тесты режима reliable_only (проверка надёжности игроков)
- [ ] Тесты завершения игры через штрафные очки
- [ ] Тесты пересдачи после завершения партии
- [ ] Тесты особых комбинаций карт (Бура, 4 конца, Молодка, Москва)

## Примечания

- Тесты используют фейковый Redis (fakeredis)
- Тесты используют in-memory SQLite базу
- Тесты мокают отправку сообщений через Centrifugo
- Каждый тест изолирован и не зависит от других

