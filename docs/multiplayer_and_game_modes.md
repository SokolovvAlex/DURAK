# Многопользовательность и режимы игры

## Обзор

Система поддерживает многопользовательские игры "Буркозел" (вариант игры в дурака) с различными режимами игры, фильтрацией игроков и механизмами поддержания качества игры.

## Многопользовательность

### Количество игроков

- **2 игрока** — классический режим "один на один"
- **3 игрока** — расширенный режим с увеличенной динамикой

### Статусы комнат

1. **`waiting`** — комната ожидает игроков (не все места заполнены)
2. **`matched`** — комната заполнена, игроки готовятся к игре
3. **`playing`** — игра идет
4. **`finished`** — игра завершена (используется для очистки)

### Поиск комнаты

- Система автоматически находит подходящую комнату по ставке и режимам игры
- Если подходящей комнаты нет, создается новая
- Матчинг происходит по совпадению:
  - Ставки
  - Количества игроков (capacity)
  - Режимов игры (speed, redeal, dark, reliable_only)

### Управление игроками

- Игроки могут покинуть комнату до начала игры (`is_ready = false`)
- Если игрок покидает комнату во время игры — он автоматически проигрывает
- Если остался 1 игрок — игра завершается, он побеждает
- Если осталось 2+ игрока — начинается новая партия между оставшимися

## Режимы игры

### 1. Режим скорости (`speed`)

**Значения:** `"normal"` (по умолчанию), `"fast"`, `"slow"`

- Контролируется фронтендом
- Влияет на таймеры ходов и скорость игры
- Не влияет на бэкенд логику

### 2. Режим пересдачи (`redeal`)

**Значение:** `true` / `false`

**Назначение:** Автоматическая пересдача карт при обнаружении особых комбинаций в руках игроков в начале раунда.

**Особые комбинации:**
- **Бура** — 3 козыря младшего достоинства (6, 7, 8)
- **4 конца** — все 4 карты одной масти
- **Молодка** — 4 карты одной масти (не козыри)
- **Москва** — 4 козыря подряд по старшинству

**Логика работы:**
1. При старте игры (`/ready`) проверяются руки всех игроков
2. Если у любого игрока обнаружена особая комбинация:
   - Карты пересдаются автоматически
   - Проверка повторяется (до 100 раз для избежания бесконечного цикла)
3. Если `redeal = false` — пересдача не происходит, игра идет с любыми картами

**Пример:**
```
Игрок получает: [6♠, 7♠, 8♠] (Бура)
Если redeal = true → карты пересдаются
Если redeal = false → игра идет с этой рукой
```

### 3. Режим скрытых карт (`dark`)

**Значение:** `true` / `false`

**Назначение:** Карты игроков скрыты от других игроков на фронтенде.

- Контролируется фронтендом
- На бэкенде логика остается неизменной
- Усложняет игру, требует больше памяти и стратегии

### 4. Режим надежных игроков (`reliable_only`)

**Значение:** `true` / `false`

**Назначение:** Ограничивает доступ к комнате только для "надежных" игроков.

**Критерий надежности:**
- Игрок считается надежным, если у него **≤ 2 ливов** за последние 10 игр
- Лив (leave) — это выход из игры во время партии (`LOSS_BY_LEAVE`)

**Логика работы:**

1. **При создании комнаты:**
   - Если `reliable_only = true`, создатель проверяется на надежность
   - Если создатель ненадежен → комната не создается, возвращается ошибка

2. **При поиске/присоединении к комнате:**
   - Если комната `reliable_only = true`, игрок проверяется на надежность
   - Если игрок ненадежен → доступ запрещен, возвращается ошибка

3. **Статистика игрока:**
   - Система анализирует последние 10 игр игрока
   - Подсчитывает количество результатов типа `LOSS_BY_LEAVE`
   - Если таких результатов ≤ 2 → игрок надежен

**Пример:**
```
Игрок А:
- Последние 10 игр: 8 побед, 1 обычное поражение, 1 лив
- Ливов: 1 → надежен ✅

Игрок Б:
- Последние 10 игр: 5 побед, 2 обычных поражения, 3 лива
- Ливов: 3 → ненадежен ❌
```

**Преимущества режима:**
- Снижает вероятность того, что игроки покинут игру посреди партии
- Повышает качество игры и стабильность
- Создает более серьезную атмосферу игры

## Финансовая система

### Ставки и начисления

- **При старте игры:** Деньги не списываются
- **При завершении игры:**
  - Проигравшие теряют свою ставку (`-stake` каждый)
  - Победитель получает только ставки проигравших (`+stake * количество проигравших`)

### Пример для 3 игроков по 1000:

```
При завершении:
- Проигравший 1: -1000
- Проигравший 2: -1000
- Победитель: +2000

Итого: -1000 - 1000 + 2000 = 0 ✅
```

### Выход из игры (лив)

- Игрок, который покинул игру (`/leave`), автоматически проигрывает
- Результат записывается как `LOSS_BY_LEAVE`
- Финансовые расчеты применяются так же, как при обычном проигрыше
- Если несколько игроков покинули игру, используется метод `apply_game_result_multiplayer`

## Система надежности

### Отслеживание надежности

- Каждый лив игрока записывается в таблицу `GameResult` с типом `LOSS_BY_LEAVE`
- Система анализирует последние 10 игр игрока
- Статистика доступна через эндпоинт `/users/{tg_id}/stats`

### Использование статистики

- При создании/присоединении к `reliable_only` комнате проверяется надежность
- Статистика отображается в профиле игрока
- Позволяет игрокам выбирать режим игры под свой стиль

## Реальный тайм

### Центрифуга (Centrifugo)

- Все события игры отправляются через Centrifugo в реальном времени
- Каналы:
  - `room#{room_id}` — события для всех игроков комнаты
  - `user#{tg_id}` — события для конкретного игрока
  - `rooms` — общий канал для списка комнат

### События

- **`game_start`** — игра началась
- **`hand`** — обновление руки игрока
- **`move`** — ход игрока
- **`reshuffle`** — пересдача карт
- **`players_out`** — игроки выбыли (не завершение игры)
- **`game_over`** — игра завершена
- **`player_joined`** — игрок присоединился
- **`player_left`** — игрок покинул
- **`new_room`** — новая комната создана
- **`close_room`** — комната закрыта

## Возврат в игру

### Механизм восстановления

- Если игрок случайно закрыл Mini App, он может вернуться
- Система проверяет, есть ли у игрока активная комната (`status = "playing"`)
- Если комната найдена:
  - Загружается полное состояние комнаты
  - Игрок подписывается на события
  - Игра продолжается с того места, где остановилась

### Условия возврата

- Комната должна существовать в Redis
- Статус комнаты: `"playing"`
- Игрок должен быть в списке `players` комнаты

## Создание и управление комнатами

### Создание комнаты

- Происходит автоматически при поиске игры (`/find_player`)
- Комната создается с уникальным ID: `{stake}_{uuid}`
- Хранится в Redis с TTL 3600 секунд (1 час)

### Параметры комнаты

- `room_id` — уникальный идентификатор
- `stake` — ставка игры
- `capacity` — количество игроков (2 или 3)
- `speed` — режим скорости
- `redeal` — режим пересдачи
- `dark` — режим скрытых карт
- `reliable_only` — режим надежных игроков
- `status` — текущий статус комнаты
- `players` — словарь игроков с их данными
- `deck` — колода карт (если игра началась)
- `trump` — козырь текущего раунда
- `seats` — фиксированный порядок игроков
- `turn_order` — порядок ходов (только активные игроки)

### Жизненный цикл комнаты

1. **Создание** → `waiting`
2. **Добавление игроков** → `waiting` или `matched`
3. **Все готовы** → `playing`
4. **Завершение игры** → комната удаляется из Redis
5. **Таймаут** → комната удаляется через 1 час

## Безопасность и валидация

### Проверки при присоединении

- Игрок не должен уже быть в комнате
- Комната не должна быть заполнена
- Баланс игрока должен быть ≥ ставки
- Для `reliable_only` комнат — проверка надежности
- Комната должна существовать и быть в статусе `waiting` или `matched`

### Проверки при игре

- Ход должен быть от правильного игрока (по `turn_order`)
- Карты должны быть в руке игрока
- Карты должны быть одной масти (при атаке)
- Защита должна быть корректной (если требуется)

## Масштабируемость

### Redis как хранилище состояния

- Все активные игры хранятся в Redis
- Быстрый доступ к данным комнаты
- Автоматическая очистка при таймауте

### PostgreSQL для постоянных данных

- Результаты игр
- Финансовые транзакции
- Статистика игроков
- Друзья

### Асинхронность

- Все операции асинхронные (FastAPI + asyncpg + aioredis)
- Поддержка множественных одновременных игр
- Эффективная обработка событий через Centrifugo

